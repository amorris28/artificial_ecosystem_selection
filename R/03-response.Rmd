---
title: "Estimate Response to Selection"
author: "Andrew Morris"
date: "`r Sys.Date()`"
output: html_document
---

This script takes in the flux data from script 01. It then plots the raw data
and the log-transformed data. Finally, it fits a linear model to the flux data
over time per treatment and tests a difference of slope between the positive
and the neutral treatment.

```{r initialize_packages, message=FALSE}
library(tidyverse)
library(morris)
library(broom)
library(knitr)
library(broman)
```

```{r initialize_variables}
source('functions.R')
```

```{r import_data, message=FALSE}
fluxes <- read_tsv(paste0(der_dir, 'fluxes.tsv'))

# Shift the passage numbers so the first passage becomes "Passage 0"
fluxes <-
  fluxes %>% 
  mutate(passage = passage - 1)
```

## Plot the raw data

```{r plot_raw}
ratio <- calc_plot_ratios(fluxes$passage, fluxes$ch4)

plot_flux(fluxes, passage, ch4, ratio)
#ggsave('fluxes_raw.pdf', width = 5, height = 4)
```

## Plot the log-transformed data

```{r plot_log10}
ratio_log10 <- calc_plot_ratios(fluxes$passage, fluxes$log_ch4)

plot_flux(fluxes, passage, log_ch4, ratio_log10, log10 = TRUE)

#ggsave('fluxes_log.pdf', width = 5, height = 4)
```

## Test a difference of slopes

```{r raw_model}
raw_model <- lm(ch4 ~ passage * treat, data = fluxes)

ggplot(raw_model, aes(x = .fitted, y = .resid)) + geom_point()

```

```{r response_model}
response_model <- lm(log_ch4 ~ passage * treat, data = fluxes)

ggplot(response_model, aes(x = .fitted, y = .resid)) + geom_point()

```

```{r no_treat_model}
# No treatment model
no_treat_model <- lm(log_ch4 ~ passage, data = fluxes)

# Back calculate the slope of the positive treatment
pos_slope <- 10^response_model$coef["passage:treatp"]
per_slope <- (10^response_model$coef["passage:treatp"] - 1) * 100
```

Here I fit two models. The first is the full model which includes passage number, treatment, and the interaction between the two. The second model includes only passage with no effect of treatment. Comparing the models using `anova` 

```{r compare_models}
# Compare interaction to no interaction
compare_response_mods <- anova(no_treat_model, response_model, test = 'LRT')
kable(tidy(compare_response_mods))
```

Here is the full interaction model:

```{r print_model}
kable(tidy(response_model))
```

```{r save_model}
save(response_model, compare_response_mods, per_slope, file = '../Output/response_model.RData')
```

The intercept for the Neutral treatment was significantly different from zero
at `r myround(tidy(response_model)[[1, 2]], 2)` (SE = `r
myround(tidy(response_model)[[1, 3]], 2)`, t = `r myround(tidy(response_model)[[1,
4]], 2)`, p = `r myround(tidy(response_model)[[1, 5]], 2)`). The Positive
treatment started at a significantly lower methane oxidation rate than the
Neutral treatment with a y-intercept of `r myround(tidy(response_model)[[3, 2]],
2)` relative to Neutral (SE = `r myround(tidy(response_model)[[3, 3]], 2)`, t = `r
myround(tidy(response_model)[[3, 4]], 2)`, p = `r myround(tidy(response_model)[[3,
5]], 2)`). There was no change in methane oxidation rate of the Neutral
treatment over the five passages (slope = `r myround(tidy(response_model)[[2, 2]],
2)`, SE = `r myround(tidy(response_model)[[2, 3]], 2)`, t = `r
myround(tidy(response_model)[[2, 4]], 2)`, p = `r myround(tidy(response_model)[[2,
5]], 2)`). By contrast, there was a significant increase in the Positive
treatment of `r myround(tidy(response_model)[[4, 2]], 2)` per passage which is
approximately a `r round((pos_slope - 1) * 100, 0)`% increase in methane
oxidation rate per passage (SE = `r myround(tidy(response_model)[[4, 3]], 2)`, t =
`r myround(tidy(response_model)[[4, 4]], 2)`, p = `r myround(tidy(response_model)[[4,
5]], 2)`).

