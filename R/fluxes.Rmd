---
title: "Artificial Ecosystem Selection"
author: "Andrew Morris"
date: "`r Sys.Date()`"
output: html_document
---


```{r global_options, include=FALSE}
knitr::opts_chunk$set(fig.width=8, fig.height=6, fig.path='Figs/',
                      echo=FALSE, warning=FALSE, message=FALSE)
```

```{r load_packages, include=FALSE}

library(tidyverse)
library(lubridate)
library(broom)
library(broman)

```

```{r import_data}

top_jars_gen1 <- c(2, 3, 13, 16)

temp <- list.files(path="../Data", pattern="FluxData*", full.names = TRUE)
conc <- sapply(temp, read.csv, stringsAsFactors = FALSE,
                 simplify = FALSE, USE.NAMES = TRUE)
names(conc) <- substr(names(conc), 18, 25)
conc <- bind_rows(conc, .id = "Date")
# Code transfers
#conc$transfer <- as.character(match(conc$Date, unique(conc$Date)))
conc$transfer[conc$Date == 20190527] <- 1
conc$transfer[conc$Date != 20190527] <- 2

# Jar broke so remove # 9 from gen 1
conc <- conc[!(conc$JAR == 9 & conc$Date == "20190527"), ]

# Jar # 1 and 2 from gen 2 had impossible ch4 values so remove
conc <- conc[!(conc$JAR == 1 & conc$Date == "20190607"), ]
conc <- conc[!(conc$JAR == 2 & conc$Date == "20190607"), ]

n1 <- length(unique(conc[conc$transfer == 1, ]$JAR))

n2 <- length(unique(conc[conc$transfer == 2, ]$JAR))
```

# Overview

This is a pilot experiment with the following goals:

  1. Determine whether there is a response to selection on soil methane oxidation
  2. Determine the size of the inoculum and selection differential to use

A set of `r n1` replicate ecosystems were generated
with 50 g of soil (sterile potting mix plus inoculum)
and sterile water to bring them to 60% of field capacity in 500 mL mason jars.
These jars were inoculated at 5% by mass and were initially kept at
atmospheric concentrations of methane. Later, they were capped and spiked to
a headspace concentration of approximately 1000 ppm CH4.  After about 8 weeks
of incubation, we finally observed significant (negative) methane fluxes. Jar
9 had the highest flux, but we observed a crack in the jar and so excluded that
data point. From the 'r n1' jars, we selected the top 4 
(jars `r top_jars_gen1`) to homogenize and transfer to the next set of ecosystems.

```{r process_data}

# Convert clock time to days and set t0 to 0 days
conc <- 
  conc  %>% 
  mutate(days = as.numeric(difftime(ymd_hms(paste0(DATE, ' ', TIME, ':00')), +
                       ISOdatetime(2019,1,1,0,0,0), unit="days"))) %>% 
  group_by(Date, JAR) %>% 
  mutate(days = days - min(days))

# Convert ppm to umol
conc$ch4_umol <- conc$CH4_CONC * 0.965 / ((0.08206 * (293)))

conc$selected[conc$JAR %in% top_jars_gen1 & conc$transfer == '1'] <- T
conc$selected[!(conc$JAR %in% top_jars_gen1) | conc$transfer != '1'] <- F
```

```{r calc_flux}

## Calculate fluxes from lm slopes
#flux <- 
#  conc %>% 
#  group_by(Date, JAR) %>%
#  do(tidy(lm(ch4_umol ~ days, data = .))) %>% 
#  filter(term == 'days')#  %>% 
#  select(Date, JAR, flux_umold = estimate)
ggplot(conc[conc$Date == "20190614" & conc$JAR == 8,], aes(x = days, y = ch4_umol)) +
  geom_point() +
  stat_smooth(method = "glm", method.args = list(family = gaussian(link = "log")))
flux <- 
  conc %>% 
  group_by(transfer, Date, JAR, selected) %>%
  #do(tidy(glm(ch4_umol ~ days, data = ., family = gaussian(link = "log")))) %>% 
    nest() %>% 
mutate(fit_glm = purrr::map(data, ~ glm(ch4_umol ~ days, data = ., family = gaussian(link = "log"))),
         fit_lm = purrr::map(data, ~ lm(ch4_umol ~ days, data = .)))
results <-
flux %>% 
  mutate(glance_lm = map(fit_lm, glance),
         glance_glm = map(fit_glm, glance)) %>% 
        unnest(glance_lm, glance_glm) %>% 
        select(transfer, Date, JAR, fit_lm, fit_glm, deviance, deviance1) %>% 
        mutate(diff_deviance = deviance - deviance1) %>% 
        select(-deviance, -deviance1)

flux$transfer[flux$Date == 20190527] <- 1
flux$transfer[flux$Date != 20190527] <- 2
flux_log$transfer[flux_log$Date == 20190527] <- 1
flux_log$transfer[flux_log$Date != 20190527] <- 2

flux$selected[flux$JAR %in% top_jars_gen1 & flux$transfer == '1'] <- T
flux$selected[!(flux$JAR %in% top_jars_gen1) | flux$transfer != '1'] <- F
flux_log$selected[flux_log$JAR %in% top_jars_gen1 & flux_log$transfer == '1'] <- T
flux_log$selected[!(flux_log$JAR %in% top_jars_gen1) | flux_log$transfer != '1'] <- F
unique(flux$Date)
all_par <- flux$flux_umold[flux$Date == '20190527']
offspr1 <- flux$flux_umold[flux$Date == '20190607']
offspr2 <- flux$flux_umold[flux$Date == '20190614']
sel_par <- flux$flux_umold[flux$transfer == '1' & flux$selected == T]

all_par_log <- flux_log$flux_umold[flux_log$Date == '20190527']
offspr1_log <- flux_log$flux_umold[flux_log$Date == '20190607']
offspr2_log <- flux_log$flux_umold[flux_log$Date == '20190614']
sel_par_log <- flux_log$flux_umold[flux_log$transfer == '1' & flux_log$selected == T]
```

```{r plot_flux_curves}
ggplot(conc, aes(x = days, y = ch4_umol, group = JAR)) + 
  geom_point() + 
  facet_wrap(~ Date, scales = "free_x")  + 
    geom_smooth(method = "glm", se = F, 
        method.args = list(family = gaussian(link = "log")))
```


For the first transfer, we used 10% inoculum intead of 5% inoculum and generated
`r initial_n2` jars, but two broke leaving `r initial_n2 -2`. After one week we observed
significant, negative methane fluxes that exceeded the first set of ecosystems. This
may have been a response to selection, a biomass effect due to the larger inoculum,
or both. So in order to truly demonstrate a response to selection we will generate at
least one more set of ecosystems through a transfer with the same inoculum size.


# Plot fluxes
```{r plot_fluxes}


ggplot(flux, aes(x = flux_umold)) +
  geom_histogram(aes(fill = selected)) +
  facet_grid(Date ~ .) +
  scale_fill_manual(values = c('black', 'red')) +
  geom_vline(xintercept = mean(all_par)) +
  geom_vline(xintercept = mean(offspr1), color = 'blue') +
  geom_vline(xintercept = mean(offspr2), color = 'darkblue') +
  geom_vline(xintercept = mean(sel_par), color = 'red') 

ggplot(flux, aes(x = Date, y = flux_umold)) +
  geom_boxplot(outlier.shape = NA) +
  geom_jitter(aes(color =selected)) +
  scale_color_manual(values = c('black', 'red')) + 
  geom_hline(yintercept = mean(all_par)) +
  geom_hline(yintercept = mean(offspr1), color = 'blue') +
  geom_hline(yintercept = mean(offspr2), color = 'darkblue') +
  geom_hline(yintercept = mean(sel_par), color = 'red') 

ggplot(flux_log, aes(x = flux_umold)) +
  geom_histogram(aes(fill = selected)) +
  facet_grid(Date ~ .) +
  scale_fill_manual(values = c('black', 'red')) +
  geom_vline(xintercept = mean(all_par_log)) +
  geom_vline(xintercept = mean(offspr1_log), color = 'blue') +
  geom_vline(xintercept = mean(offspr2_log), color = 'darkblue') +
  geom_vline(xintercept = mean(sel_par_log), color = 'red') 

ggplot(flux_log, aes(x = Date, y = flux_umold)) +
  geom_boxplot(outlier.shape = NA) +
  geom_jitter(aes(color =selected)) +
  scale_color_manual(values = c('black', 'red')) + 
  geom_hline(yintercept = mean(all_par_log)) +
  geom_hline(yintercept = mean(offspr1_log), color = 'blue') +
  geom_hline(yintercept = mean(offspr2_log), color = 'darkblue') +
  geom_hline(yintercept = mean(sel_par_log), color = 'red') 
```

# Calculate narrow-sense heritability

```{r calc_heritability}

ns_heritability <- function(all_par, offspr, sel_par) {
  R <- mean(all_par) - mean(offspr)
  S <- mean(all_par) - mean(sel_par)
  h2 <- R / S
  h2
  # Where:
  # h2 is the narrow-sense heritability
  # R is the realized average difference between the parent generation
  #     and the next generation
  # S is the average difference between the parent generation and the selected
  #     parents
}

nsh1 <- ns_heritability(all_par, offspr1, sel_par) 
nsh2 <- ns_heritability(all_par, offspr2, sel_par) 
nsh1_log <- ns_heritability(all_par_log, offspr1_log, sel_par_log)
nsh2_log <- ns_heritability(all_par_log, offspr2_log, sel_par_log)
```

Based on the mean ecosystem-level trait values from the first and second set
of ecosystems, we calculated narrow-sense heritability as $h^2 = R / S$, which
was `r myround(nsh)` for the linear model and `r myround(nsh_log)` for the exponential
model. Granted, this is also not a valid estimate, because of the difference
in inoculum size. We will calculate this again between transfer 2 and 3 to get a more
legitimate estimate.

# Identify selected individuals from transfer 2

```{r identify_top_jars} 
flux %>% 
  group_by(Date) %>% 
  top_n(-4, flux_umold)
flux_log %>% 
  group_by(Date) %>% 
  top_n(-4, flux_umold)
```
