---
title: "Artificial Ecosystem Selection"
author: "Andrew Morris"
date: "`r Sys.Date()`"
output: html_document
---


```{r global_options, include=FALSE}
knitr::opts_chunk$set(fig.width=8, fig.height=6, fig.path='Figs/',
                      echo=FALSE, warning=FALSE, message=FALSE)
```

```{r load_packages, include=FALSE}

library(tidyverse)
library(lubridate)
library(broom)
library(broman)

```

```{r import_data}

top_jars_gen1 <- c(2, 3, 13, 16)

temp <- list.files(path="../Data", pattern="FluxData*", full.names = TRUE)
conc <- sapply(temp, read.csv, stringsAsFactors = FALSE,
                 simplify = FALSE, USE.NAMES = TRUE)
names(conc) <- substr(names(conc), 18, 25)
conc <- bind_rows(conc, .id = "Date")

# Code transfers
conc$transfer <- as.character(match(conc$Date, unique(conc$Date)))

initial_n1 <- length(unique(conc[conc$transfer == 1, ]$JAR))

initial_n2 <- length(unique(conc[conc$transfer == 2, ]$JAR))
```

# Overview

This is a pilot experiment with the following goals:

  1. Determine whether there is a response to selection on soil methane oxidation
  2. Determine the size of the inoculum and selection differential to use

A set of `r initial_n1` replicate ecosystems were generated
with 50 g of soil (sterile potting mix plus inoculum)
and sterile water to bring them to 60% of field capacity in 500 mL mason jars.
These jars were inoculated at 5% by mass and were initially kept at
atmospheric concentrations of methane. Later, they were capped and spiked to
a headspace concentration of approximately 1000 ppm CH4.  After about 8 weeks
of incubation, we finally observed significant (negative) methane fluxes. Jar
9 had the highest flux, but we observed a crack in the jar and so excluded that
data point. From the remaining `r initial_n1 - 1` jars, we selected the top 4 
(jars `r top_jars_gen1`) to homogenize and transfer to the next set of ecosystems.






```{r process_data}
# Jar broke so remove # 9 from gen 1
conc <- conc[!(conc$JAR == 9 & conc$Date == "20190527"), ]

# Jar # 1 and 2 from gen 2 had impossible ch4 values so remove
conc <- conc[!(conc$JAR == 1 & conc$Date == "20190607"), ]
conc <- conc[!(conc$JAR == 2 & conc$Date == "20190607"), ]

# Convert clock time to days and set t0 to 0 days
conc <- 
  conc  %>% 
  mutate(days = period_to_seconds(hms(paste0(conc$TIME, ':00'))) / 60 / 60) %>% 
  group_by(Date, JAR) %>% 
  mutate(days = days - min(days))

# Convert ppm to umol
conc$ch4_umol <- conc$CH4_CONC * 0.965 / ((0.08206 * (293)))

# Calculate fluxes from lm slopes
flux <- 
  conc %>% 
  group_by(transfer, JAR) %>%
  do(tidy(lm(ch4_umol ~ days, data = .))) %>% 
  filter(term == 'days')  %>% 
  select(transfer, JAR, flux_umold = estimate)

# Identify the jars that were used for selection
flux$selected[flux$JAR %in% top_jars_gen1 & flux$transfer == '1'] <- T
flux$selected[!(flux$JAR %in% top_jars_gen1) | flux$transfer != '1'] <- F

all_par <- flux$flux_umold[flux$transfer == '1']
offspr <- flux$flux_umold[flux$transfer == '2']
sel_par <- flux$flux_umold[flux$transfer == '1' & flux$selected == T]

```

For the first transfer, we used 10% inoculum intead of 5% inoculum and generated
`r initial_n2` jars, but two broke leaving `r initial_n2 -2`. After one week we observed
significant, negative methane fluxes that exceeded the first set of ecosystems. This
may have been a response to selection, a biomass effect due to the larger inoculum,
or both. So in order to truly demonstrate a response to selection we will generate at
least one more set of ecosystems through a transfer with the same inoculum size.


# Plot fluxes
```{r plot_fluxes}


ggplot(flux, aes(x = flux_umold, fill = selected)) +
  geom_histogram(aes(fill = interaction(transfer, selected))) +
  facet_grid(transfer ~ .) +
  scale_fill_manual(values = c('black', 'blue', 'red')) +
  geom_vline(xintercept = mean(all_par)) +
  geom_vline(xintercept = mean(offspr), color = 'blue') +
  geom_vline(xintercept = mean(sel_par), color = 'red') 
ggsave('../Figures/transfer12_hist.pdf', width = 5, height = 5)

ggplot(flux, aes(x = transfer, y = flux_umold)) +
  geom_boxplot(aes(color = transfer), outlier.shape = NA) +
  geom_jitter(aes(color = interaction(transfer, selected))) +
  scale_color_manual(values = c('black', 'black', 'red', 'blue', 'blue')) + 
  geom_hline(yintercept = mean(all_par)) +
  geom_hline(yintercept = mean(offspr), color = 'blue') +
  geom_hline(yintercept = mean(sel_par), color = 'red') 

ggsave('../Figures/transfer12_box.pdf', width = 5, height = 5)
# Calculate heritability 

```

# Calculate narrow-sense heritability

```{r calc_heritability}

ns_heritability <- function(all_par, offspr, sel_par) {
  R <- mean(all_par) - mean(offspr)
  S <- mean(all_par) - mean(sel_par)
  h2 <- R / S
  h2
  # Where:
  # h2 is the narrow-sense heritability
  # R is the realized average difference between the parent generation
  #     and the next generation
  # S is the average difference between the parent generation and the selected
  #     parents
}

nsh <- ns_heritability(all_par, offspr, sel_par) 
```

Based on the mean ecosystem-level trait values from the first and second set
of ecosystems, we calculated narrow-sense heritability as $h^2 = R / S$, which
was `r myround(nsh)`. Granted, this is also not a valid estimate, because of the difference
in inoculum size. We will calculate this again between transfer 2 and 3 to get a more
legitimate estimate.

# Identify selected individuals from transfer 2

```{r identify_top_jars} 
flux %>% 
  group_by(transfer) %>% 
  top_n(-4, flux_umold)
```
