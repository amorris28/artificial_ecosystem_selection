---
title: "Artificial Ecosystem Selection"
author: "Andrew Morris"
date: "`r Sys.Date()`"
output: html_document
---


```{r global_options, include=FALSE}
knitr::opts_chunk$set(fig.width=8, fig.height=6, fig.path='Figs/',
                      echo=FALSE, warning=FALSE, message=FALSE)
```

```{r load_packages, include=FALSE}

library(tidyverse)
library(lubridate)
library(broom)
library(broman)
library(purrr)
library(kableExtra)
library(morris)

```


```{r import_data}

top_jars_pas1 <- c(2, 3, 13, 16)
top_jars_pas2 <- c(6, 8, 17, 21)

temp <- list.files(path="../Data", pattern="FluxData*", full.names = TRUE)
conc <- sapply(temp, read.csv, stringsAsFactors = FALSE,
                 simplify = FALSE, USE.NAMES = TRUE)
names(conc) <- substr(names(conc), 18, 25)
conc <- bind_rows(conc, .id = "Date")
# Code transfers
#conc$transfer <- as.character(match(conc$Date, unique(conc$Date)))
conc$transfer[conc$Date == 20190527] <- 1
conc$transfer[conc$Date != 20190527] <- 2

# Jar broke so remove # 9 from gen 1
conc <- conc[!(conc$JAR == 9 & conc$Date == "20190527"), ]

# Jar # 1 and 2 from gen 2 had impossible ch4 values so remove
conc <- conc[!(conc$JAR == 1 & conc$Date == "20190607"), ]
conc <- conc[!(conc$JAR == 2 & conc$Date == "20190607"), ]

n1 <- length(unique(conc[conc$transfer == 1, ]$JAR))

n2 <- length(unique(conc[conc$transfer == 2, ]$JAR))

# The two SCs from passage 2, week 1
sc_1 <- function(x) {(0.1904*x)+58.823}
sc_2 <- function(x) {(0.1427*x)+99.075}

# Convert the saved concentrations (using two different curves) to using
# one or the other
conc <- 
  conc  %>% 
  mutate_cond(Date == "20190607", CH4_CONC = sc_1(CH4_AREA))
# Confirmed that the weirdly high fluxes in Passage 2, Week 1 were due to 
# using two different standard curves


```

## Overview

This is a pilot experiment to demonstrate a response to selection on
soil methane oxidation at the ecosystem/community level. We hope to demonstrate a
change in mean trait value as a response to selection that is greater than 
neutral selection, to calculate community heritability using the breeder's equation, 
and to identify microbial taxa that change in abundance or presence/absence due to 
selection. This pilot experiment has the following goals:

  1. Determine whether there is a response to selection on soil methane oxidation
  2. Determine the experimental setup including the size of the inoculum, the 
     selection differential, the generation time, and the environmental conditions
     (e.g. methane concentration) to achieve a response to selection

A set of `r n1` replicate ecosystems were generated
with 50 g of soil (sterile potting mix plus 5% inoculum by mass)
and sterile water to bring them to 60% of field capacity in 500 mL mason jars.
These jars were initially kept at atmospheric concentrations of methane, but did not 
display significant methane oxidation rates after ~6 weeks. As a result, 
they were capped and spiked to
a headspace concentration of approximately 1000 ppm CH4. Both CH4 and CO2 were monitored
daily and it was determined that flushing and respiking was required every three
days in order to maintain aerobic conditions and an elevated CH4 concentration. After about 8 weeks
of incubation (2 weeks at 1000 ppm), we finally observed significant (negative)
methane fluxes. From the `r n1` jars, we selected the top 4 
(jars `r top_jars_pas1`) to homogenize and transfer to the next set of ecosystems.


For the first transfer, we used 10% inoculum intead of 5% inoculum and generated
`r n2` jars. After one week we observed
significant, negative methane fluxes that exceeded the first set of ecosystems. This
may have been a response to selection, a biomass effect due to the larger inoculum,
or both. After two weeks, we observed dampened fluxes compared to week one, but still
greater flux than before the first transfer. The elevated fluxes in week 1 compared
to week 2 could have been a result of using two different standard curves for t0 and t1
and for t2 and t3 in week 1 or due to some temporal effect during the incubations 
(e.g. response to water addition or initial available nutrients or growth).
In order to truly demonstrate a response to selection we will generate at
least one more set of ecosystems through a transfer with the same inoculum size
(10%) using jars `r top_jars_pas2` from passage 2.

```{r process_data}

# Convert clock time to days and set t0 to 0 days
conc <- 
  conc  %>% 
  mutate(days = as.numeric(difftime(ymd_hms(paste0(DATE, ' ', TIME, ':00')), +
                       ISOdatetime(2019,1,1,0,0,0), unit="days"))) %>% 
  group_by(Date, JAR) %>% 
  mutate(days = days - min(days))

# Convert ppm to umol
conc$ch4_umol <- conc$CH4_CONC * 0.965 / ((0.08206 * (293)))

conc$selected[conc$JAR %in% top_jars_pas1 & conc$transfer == '1'] <- T
conc$selected[conc$JAR %in% top_jars_pas2 & conc$transfer == '2'] <- T
conc$selected[!(conc$JAR %in% top_jars_pas1) & conc$transfer == '1'] <- F
conc$selected[!(conc$JAR %in% top_jars_pas2) & conc$transfer == '2'] <- F
```

## Raw flux curves

The raw methane concentration data for each methane flux measurement labelled by
jar and the date the measurement was taken. The red lines indicate the regression
line for OLS regression and the blue line indicates the regression line for 
glm (link = log). Both x and y axes are allowed to vary.

```{r plot_flux_curves, fig.width=10, fig.height=15}
ggplot(conc, aes(x = days, y = ch4_umol, group = JAR)) + 
  geom_point() + 
  facet_wrap(~ Date + JAR, scales = "free")  + 
  stat_smooth(method = "glm", se = F, color = 'blue', alpha = 0.4, geom = 'line',
              size = 1,
              method.args = list(family = gaussian(link = "log"))) + 
  stat_smooth(method = 'lm', se = F, color = 'red', alpha = 0.4, geom = 'line', size = 1) +
  labs(x = "Time (days)", y = expression(CH[4] ~ "Concentration" ~ (mu * Mol)))
```

```{r calc_flux}

#ggplot(conc[conc$Date == "20190614" & conc$JAR == 8,], aes(x = days, y = ch4_umol)) +
#  geom_point() +
#  stat_smooth(method = "glm", method.args = list(family = gaussian(link = "log"))) +
#  stat_smooth(method = "lm", color = "red")
#
#ggplot(conc[conc$Date == "20190614" & conc$JAR == 20,], aes(x = days, y = ch4_umol)) +
#  geom_point() +
#  stat_smooth(method = "glm", method.args = list(family = gaussian(link = "log"))) +
#  stat_smooth(method = "lm", color = "red")
#
#ggplot(conc[conc$Date == "20190527" & conc$JAR == 16,], aes(x = days, y = ch4_umol)) +
#  geom_point() +
#  stat_smooth(method = "glm", method.args = list(family = gaussian(link = "log"))) +
#  stat_smooth(method = "lm", color = "red")

flux <- 
  conc %>% 
  group_by(transfer, Date, JAR, selected) %>%
  nest() %>%
  mutate(fit_lm = map(data, ~ lm(ch4_umol ~ days, data = .)),
         fit_glm = map(data, ~ glm(ch4_umol ~ days, data = ., family = gaussian(link = "log"))))

  comp_dev <- 
flux  %>% 
  mutate(glance_lm = map(fit_lm, glance),
         glance_glm = map(fit_glm, glance)) %>% 
  unnest(glance_lm, glance_glm)  %>% 
  select(transfer, Date, JAR, selected, data, fit_lm, fit_glm, df.null, deviance_lm = deviance, deviance_glm = deviance1) %>% 
  mutate(dev_diff = deviance_lm - deviance_glm, dev_bool = deviance_lm >= deviance_glm)

flux <- 
flux %>%
  mutate(tidy_lm = map(fit_lm, tidy),
         tidy_glm = map(fit_glm, tidy)) %>% 
unnest(tidy_lm, tidy_glm) %>% 
filter(term == 'days') %>% 
select(transfer, Date, JAR, selected, lm_umold = estimate, glm_umold = estimate1)  %>% 
mutate(glm_umold_exp = exp(glm_umold))

all_par <- flux$lm_umold[flux$Date == '20190527']
offspr1 <- flux$lm_umold[flux$Date == '20190607']
offspr2 <- flux$lm_umold[flux$Date == '20190614']
sel_par1 <- flux$lm_umold[flux$transfer == '1' & flux$selected == T]
sel_par2 <- flux$lm_umold[flux$Date == '20190614' & flux$selected == T]

all_par_log <- flux$glm_umold[flux$Date == '20190527']
offspr1_log <- flux$glm_umold[flux$Date == '20190607']
offspr2_log <- flux$glm_umold[flux$Date == '20190614']
sel_par1_log <- flux$glm_umold[flux$transfer == '1' & flux$selected == T]
sel_par2_log <- flux$glm_umold[flux$Date == '20190614' & flux$selected == T]

all_par_exp <- flux$glm_umold_exp[flux$Date == '20190527']
offspr1_exp <- flux$glm_umold_exp[flux$Date == '20190607']
offspr2_exp <- flux$glm_umold_exp[flux$Date == '20190614']
sel_par1_exp <- flux$glm_umold_exp[flux$transfer == '1' & flux$selected == T]
sel_par2_exp <- flux$glm_umold_exp[flux$Date == '20190614' & flux$selected == T]
```


## Plot fluxes

Histograms and boxplots of the distribution of methane oxidation rates across jars. 
The first date is from the first set of jars with the four jars used as the
inoculum in the first transfer indicated in red. The second date is Transfer 2, Week1
and the third date is Transfer 2, Week 1. The black line is the
mean methane flux for the parent generation, the red line is the mean methane
flux for the selected jars, the light blue line is the mean methane flux
for transfer 2 week 1 and the dark blue line is the mean metahne flux for
transfer 2 week 2. Methane fluxes are negtaive, because it's a consumptive
process (methane oxidation). The first two plots have fluxes calculated from simple
linear regression. The second two plots have fluxes calculated from a glm
(family = Gaussian, link = log) to better match the exponential decay function
for methane oxidation.

```{r plot_fluxes}


ggplot(flux, aes(x = lm_umold)) +
  geom_histogram(aes(fill = interaction(selected, Date))) +
  facet_grid(Date + transfer ~ .) +
  scale_fill_manual(values = c('darkred', 'red', 'darkblue', 'blue', 'darkorange', 'orange')) +
  geom_vline(xintercept = mean(all_par), color = 'darkred') +
  geom_vline(xintercept = mean(offspr1), color = 'darkblue') +
  geom_vline(xintercept = mean(offspr2), color = 'darkorange') +
  geom_vline(xintercept = mean(sel_par1), color = 'red') +
  geom_vline(xintercept = mean(sel_par2), color = 'orange') +
  labs(x = expression (CH[4] ~ "Flux" ~ (mu * "Mol"* ~ d^{-1})), y = "Number of Jars", title = "LM Fluxes")

ggplot(flux, aes(x = Date, y = lm_umold)) +
  facet_wrap(~ transfer + Date, scales = 'free_x') + 
  geom_boxplot(outlier.shape = NA) +
  geom_jitter(aes(color = interaction(selected, Date))) +
  scale_color_manual(values = c('darkred', 'red', 'darkblue', 'blue', 'darkorange', 'orange')) + 
  geom_hline(yintercept = mean(all_par), color = 'darkred') +
  geom_hline(yintercept = mean(offspr1), color = 'darkblue') +
  geom_hline(yintercept = mean(offspr2), color = 'darkorange') +
  geom_hline(yintercept = mean(sel_par1), color = 'red')  + 
  geom_hline(yintercept = mean(sel_par2), color = 'orange')  + 
  labs(y = expression (CH[4] ~ "Flux" ~ (mu * "Mol"* ~ d^{-1})), x = "Measurement Date", title = "LM Fluxes")

ggplot(flux, aes(x = glm_umold)) +
  geom_histogram(aes(fill = interaction(selected, Date))) +
  facet_grid(Date + transfer ~ .) +
  scale_fill_manual(values = c('darkred', 'red', 'darkblue', 'blue', 'darkorange', 'orange')) +
  geom_vline(xintercept = mean(all_par_log), color = 'darkred') +
  geom_vline(xintercept = mean(offspr1_log), color = 'darkblue') +
  geom_vline(xintercept = mean(offspr2_log), color = 'darkorange') +
  geom_vline(xintercept = mean(sel_par1_log), color = 'red') +
  geom_vline(xintercept = mean(sel_par2_log), color = 'orange') +
  labs(x = expression (CH[4] ~ "Flux" ~ (mu * "Mol"* ~ d^{-1})), y = "Number of Jars", title = "GLM Fluxes")

ggplot(flux, aes(x = Date, y = glm_umold)) +
  facet_wrap(~ transfer + Date, scales = 'free_x') + 
  geom_boxplot(outlier.shape = NA) +
  geom_jitter(aes(color = interaction(selected, Date))) +
  scale_color_manual(values = c('darkred', 'red', 'darkblue', 'blue', 'darkorange', 'orange')) + 
  geom_hline(yintercept = mean(all_par_log), color = 'darkred') +
  geom_hline(yintercept = mean(offspr1_log), color = 'darkblue') +
  geom_hline(yintercept = mean(offspr2_log), color = 'darkorange') +
  geom_hline(yintercept = mean(sel_par1_log), color = 'red') +
  geom_hline(yintercept = mean(sel_par2_log), color = 'orange') +
  labs(y = expression (CH[4] ~ "Flux" ~ (mu * "Mol"* ~ d^{-1})), x = "Measurement Date", title = "GLM Fluxes")

ggplot(flux, aes(x = glm_umold_exp)) +
  geom_histogram(aes(fill = interaction(selected, Date))) +
  facet_grid(Date + transfer ~ .) +
  scale_fill_manual(values = c('darkred', 'red', 'darkblue', 'blue', 'darkorange', 'orange')) +
  geom_vline(xintercept = mean(all_par_exp), color = 'darkred') +
  geom_vline(xintercept = mean(offspr1_exp), color = 'darkblue') +
  geom_vline(xintercept = mean(offspr2_exp), color = 'darkorange') +
  geom_vline(xintercept = mean(sel_par1_exp), color = 'red') +
  geom_vline(xintercept = mean(sel_par2_exp), color = 'orange') +
  labs(x = expression (CH[4] ~ "Flux" ~ (mu * "Mol"* ~ d^{-1})), y = "Number of Jars", title = "GLM Fluxes")

ggplot(flux, aes(x = Date, y = glm_umold_exp)) +
  facet_wrap(~ transfer + Date, scales = 'free_x') + 
  geom_boxplot(outlier.shape = NA) +
  geom_jitter(aes(color = interaction(selected, Date))) +
  scale_color_manual(values = c('darkred', 'red', 'darkblue', 'blue', 'darkorange', 'orange')) + 
  geom_hline(yintercept = mean(all_par_exp), color = 'darkred') +
  geom_hline(yintercept = mean(offspr1_exp), color = 'darkblue') +
  geom_hline(yintercept = mean(offspr2_exp), color = 'darkorange') +
  geom_hline(yintercept = mean(sel_par1_exp), color = 'red') +
  geom_hline(yintercept = mean(sel_par2_exp), color = 'orange') +
  labs(y = expression (CH[4] ~ "Flux" ~ (mu * "Mol"* ~ d^{-1})), x = "Measurement Date", title = "GLM Fluxes")
```

## Calculate narrow-sense heritability

```{r calc_heritability}

ns_heritability <- function(all_par, offspr, sel_par) {
  R <- mean(all_par) - mean(offspr)
  S <- mean(all_par) - mean(sel_par)
  h2 <- R / S
  h2
  # Where:
  # h2 is the narrow-sense heritability
  # R is the realized average difference between the parent generation
  #     and the next generation
  # S is the average difference between the parent generation and the selected
  #     parents
}

nsh1 <- ns_heritability(all_par, offspr1, sel_par1) 
nsh2 <- ns_heritability(all_par, offspr2, sel_par1) 
nsh1_log <- ns_heritability(all_par_log, offspr1_log, sel_par1_log)
nsh2_log <- ns_heritability(all_par_log, offspr2_log, sel_par1_log)
nsh1_exp <- ns_heritability(all_par_exp, offspr1_exp, sel_par1_exp)
nsh2_exp <- ns_heritability(all_par_exp, offspr2_exp, sel_par1_exp)
```

Based on the mean ecosystem-level trait values from the first and second set
of ecosystems (week 2), we calculated narrow-sense heritability as $h^2 = R / S$, which
was `r myround(nsh2, 2)` for the linear model and `r myround(nsh2_log, 2)` for the exponential
model and `r myround(nsh2_exp, 2)` for the back-transformed exponential coefficient. 
Granted, this is also not a valid estimate, because of the difference
in inoculum size between transfer 1 and 2. We will calculate this again between
transfer 2 and 3 to get a more accurate estimate.

## Identify selected individuals from transfer 2

```{r identify_top_jars} 
flux %>% 
  group_by(Date) %>% 
  top_n(-4, lm_umold) %>% 
  kable(caption = "Linear model fluxes. transfer is the ecosystem generation,
        Date is the flux measurement date, JAR lists the top 4 jars from that sample
        date in terms of methane flux from a linear model, 
        selected indicates whether they were the
        selected parents for transfer 1, lm_umold is uMol/d flux based on a linear
        regression and glm_umold is uMol/d flux based on a glm with family = Gaussian
        and link = log") %>% 
  kable_styling()
flux %>% 
  group_by(Date) %>% 
  top_n(-4, glm_umold) %>% 
  kable(caption = "Generalized linear model link = log fluxes. Same as above except
        JAR indicates top 4 jars from a glm.") %>% 
  kable_styling()
flux %>% 
  group_by(Date) %>% 
  top_n(-4, glm_umold_exp) %>% 
  kable(caption = "Generalized linear model link = log fluxes. Same as above except
        JAR indicates top 4 jars from a glm and instead of slopes it's the exp(coef)
        so it's a multiplicative factor.") %>% 
  kable_styling()
```
