---
title: "Artificial Ecosystem Selection"
author: "Andrew Morris"
date: "`r Sys.Date()`"
output: html_document
---


```{r global_options, include=FALSE}
knitr::opts_chunk$set(fig.width=8, fig.height=6, fig.path='Figs/',
                      echo=FALSE, warning=FALSE, message=FALSE)
```

```{r load_packages, include=FALSE}

library(tidyverse)
library(lubridate)
library(broom)
library(broman)
library(purrr)
library(kableExtra)

```

```{r import_data}

top_jars_gen1 <- c(2, 3, 13, 16)

temp <- list.files(path="../Data", pattern="FluxData*", full.names = TRUE)
conc <- sapply(temp, read.csv, stringsAsFactors = FALSE,
                 simplify = FALSE, USE.NAMES = TRUE)
names(conc) <- substr(names(conc), 18, 25)
conc <- bind_rows(conc, .id = "Date")
# Code transfers
#conc$transfer <- as.character(match(conc$Date, unique(conc$Date)))
conc$transfer[conc$Date == 20190527] <- 1
conc$transfer[conc$Date != 20190527] <- 2

# Jar broke so remove # 9 from gen 1
conc <- conc[!(conc$JAR == 9 & conc$Date == "20190527"), ]

# Jar # 1 and 2 from gen 2 had impossible ch4 values so remove
conc <- conc[!(conc$JAR == 1 & conc$Date == "20190607"), ]
conc <- conc[!(conc$JAR == 2 & conc$Date == "20190607"), ]

n1 <- length(unique(conc[conc$transfer == 1, ]$JAR))

n2 <- length(unique(conc[conc$transfer == 2, ]$JAR))
```

# Overview

This is a pilot experiment with the following goals:

  1. Determine whether there is a response to selection on soil methane oxidation
  2. Determine the size of the inoculum and selection differential to use

A set of `r n1` replicate ecosystems were generated
with 50 g of soil (5% sterile potting mix plus inoculum)
and sterile water to bring them to 60% of field capacity in 500 mL mason jars.
These jars were initially kept at
atmospheric concentrations of methane. Later, they were capped and spiked to
a headspace concentration of approximately 1000 ppm CH4.  After about 8 weeks
of incubation (2 weeks at 1000 ppm), we finally observed significant (negative) methane fluxes. From the 'r n1' jars, we selected the top 4 
(jars `r top_jars_gen1`) to homogenize and transfer to the next set of ecosystems.

```{r process_data}

# Convert clock time to days and set t0 to 0 days
conc <- 
  conc  %>% 
  mutate(days = as.numeric(difftime(ymd_hms(paste0(DATE, ' ', TIME, ':00')), +
                       ISOdatetime(2019,1,1,0,0,0), unit="days"))) %>% 
  group_by(Date, JAR) %>% 
  mutate(days = days - min(days))

# Convert ppm to umol
conc$ch4_umol <- conc$CH4_CONC * 0.965 / ((0.08206 * (293)))

conc$selected[conc$JAR %in% top_jars_gen1 & conc$transfer == '1'] <- T
conc$selected[!(conc$JAR %in% top_jars_gen1) | conc$transfer != '1'] <- F
```


```{r plot_flux_curves, fig.width=10, fig.height=15}
ggplot(conc, aes(x = days, y = ch4_umol, group = JAR)) + 
  geom_point() + 
  facet_wrap(~ Date + JAR, scales = "free")  + 
  stat_smooth(method = "glm", se = F, color = 'blue', alpha = 0.5, geom = 'line',
              method.args = list(family = gaussian(link = "log"))) + 
  stat_smooth(method = 'lm', se = F, color = 'red', alpha = 0.5, geom = 'line')
```

```{r calc_flux}

#ggplot(conc[conc$Date == "20190614" & conc$JAR == 8,], aes(x = days, y = ch4_umol)) +
#  geom_point() +
#  stat_smooth(method = "glm", method.args = list(family = gaussian(link = "log"))) +
#  stat_smooth(method = "lm", color = "red")
#
#ggplot(conc[conc$Date == "20190614" & conc$JAR == 20,], aes(x = days, y = ch4_umol)) +
#  geom_point() +
#  stat_smooth(method = "glm", method.args = list(family = gaussian(link = "log"))) +
#  stat_smooth(method = "lm", color = "red")
#
#ggplot(conc[conc$Date == "20190527" & conc$JAR == 16,], aes(x = days, y = ch4_umol)) +
#  geom_point() +
#  stat_smooth(method = "glm", method.args = list(family = gaussian(link = "log"))) +
#  stat_smooth(method = "lm", color = "red")

flux <- 
  conc %>% 
  group_by(transfer, Date, JAR, selected) %>%
  nest() %>%
  mutate(fit_lm = map(data, ~ lm(ch4_umol ~ days, data = .)),
         fit_glm = map(data, ~ glm(ch4_umol ~ days, data = ., family = gaussian(link = "log"))))

  comp_dev <- 
flux  %>% 
  mutate(glance_lm = map(fit_lm, glance),
         glance_glm = map(fit_glm, glance)) %>% 
  unnest(glance_lm, glance_glm)  %>% 
  select(transfer, Date, JAR, selected, data, fit_lm, fit_glm, df.null, deviance_lm = deviance, deviance_glm = deviance1) %>% 
  mutate(dev_diff = deviance_lm - deviance_glm, dev_bool = deviance_lm >= deviance_glm)

flux <- 
flux %>%
  mutate(tidy_lm = map(fit_lm, tidy),
         tidy_glm = map(fit_glm, tidy)) %>% 
unnest(tidy_lm, tidy_glm) %>% 
filter(term == 'days') %>% 
select(transfer, Date, JAR, selected, lm_umold = estimate, glm_umold = estimate1)

all_par <- flux$lm_umold[flux$Date == '20190527']
offspr1 <- flux$lm_umold[flux$Date == '20190607']
offspr2 <- flux$lm_umold[flux$Date == '20190614']
sel_par <- flux$lm_umold[flux$transfer == '1' & flux$selected == T]

all_par_log <- flux$glm_umold[flux$Date == '20190527']
offspr1_log <- flux$glm_umold[flux$Date == '20190607']
offspr2_log <- flux$glm_umold[flux$Date == '20190614']
sel_par_log <- flux$glm_umold[flux$transfer == '1' & flux$selected == T]

```

For the first transfer, we used 10% inoculum intead of 5% inoculum and generated
`r n2` jars. After one week we observed
significant, negative methane fluxes that exceeded the first set of ecosystems. This
may have been a response to selection, a biomass effect due to the larger inoculum,
or both. After two weeks, we observed dampened flxues compared to week one, but still
greater flux than before the firs transfer. The elevated fluxes in week 1 compared
to week 2 could have been a result of using two different standard curves for t0 and t1
and for t2 and t3 in week 1 or due to some temporal effect during the incubations 
(e.g. response to water addition or initial available nutrients or growth).
In order to truly demonstrate a response to selection we will generate at
least one more set of ecosystems through a transfer with the same inoculum size
(10%).


# Plot fluxes
```{r plot_fluxes}


ggplot(flux, aes(x = lm_umold)) +
  geom_histogram(aes(fill = selected)) +
  facet_grid(Date ~ .) +
  scale_fill_manual(values = c('black', 'red')) +
  geom_vline(xintercept = mean(all_par)) +
  geom_vline(xintercept = mean(offspr1), color = 'blue') +
  geom_vline(xintercept = mean(offspr2), color = 'darkblue') +
  geom_vline(xintercept = mean(sel_par), color = 'red') 

ggplot(flux, aes(x = Date, y = lm_umold)) +
  geom_boxplot(outlier.shape = NA) +
  geom_jitter(aes(color =selected)) +
  scale_color_manual(values = c('black', 'red')) + 
  geom_hline(yintercept = mean(all_par)) +
  geom_hline(yintercept = mean(offspr1), color = 'blue') +
  geom_hline(yintercept = mean(offspr2), color = 'darkblue') +
  geom_hline(yintercept = mean(sel_par), color = 'red') 

ggplot(flux, aes(x = glm_umold)) +
  geom_histogram(aes(fill = selected)) +
  facet_grid(Date ~ .) +
  scale_fill_manual(values = c('black', 'red')) +
  geom_vline(xintercept = mean(all_par_log)) +
  geom_vline(xintercept = mean(offspr1_log), color = 'blue') +
  geom_vline(xintercept = mean(offspr2_log), color = 'darkblue') +
  geom_vline(xintercept = mean(sel_par_log), color = 'red') 

ggplot(flux, aes(x = Date, y = glm_umold)) +
  geom_boxplot(outlier.shape = NA) +
  geom_jitter(aes(color =selected)) +
  scale_color_manual(values = c('black', 'red')) + 
  geom_hline(yintercept = mean(all_par_log)) +
  geom_hline(yintercept = mean(offspr1_log), color = 'blue') +
  geom_hline(yintercept = mean(offspr2_log), color = 'darkblue') +
  geom_hline(yintercept = mean(sel_par_log), color = 'red') 
```

# Calculate narrow-sense heritability

```{r calc_heritability}

ns_heritability <- function(all_par, offspr, sel_par) {
  R <- mean(all_par) - mean(offspr)
  S <- mean(all_par) - mean(sel_par)
  h2 <- R / S
  h2
  # Where:
  # h2 is the narrow-sense heritability
  # R is the realized average difference between the parent generation
  #     and the next generation
  # S is the average difference between the parent generation and the selected
  #     parents
}

nsh1 <- ns_heritability(all_par, offspr1, sel_par) 
nsh2 <- ns_heritability(all_par, offspr2, sel_par) 
nsh1_log <- ns_heritability(all_par_log, offspr1_log, sel_par_log)
nsh2_log <- ns_heritability(all_par_log, offspr2_log, sel_par_log)
```

Based on the mean ecosystem-level trait values from the first and second set
of ecosystems (week 2), we calculated narrow-sense heritability as $h^2 = R / S$, which
was `r myround(nsh2)` for the linear model and `r myround(nsh2_log)` for the exponential
model. Granted, this is also not a valid estimate, because of the difference
in inoculum size between transfer 1 and 2. We will calculate this again between
transfer 2 and 3 to get a more accurate estimate.

# Identify selected individuals from transfer 2

```{r identify_top_jars} 
flux %>% 
  group_by(Date) %>% 
  top_n(-4, lm_umold) %>% 
  kable(caption = "Linear model fluxes") %>% 
  kable_styling()
flux %>% 
  group_by(Date) %>% 
  top_n(-4, glm_umold) %>% 
  kable(caption = "Generalized linear model link = log fluxes") %>% 
  kable_styling()
```
