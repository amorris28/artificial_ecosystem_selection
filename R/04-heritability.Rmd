---
title: "Heritability"
author: "Andrew Morris"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = TRUE)
knitr::opts_knit$set(root.dir=normalizePath('../'))

```

This script imports the heritability data. This dataset includes the mean flux
within treatment by generation for 1) all parents, 2) selected parents, and 3)
offspring. Then, it plots offspring on the selected parents with the two
treatments combined and then separately for the two treatments.



```{r initialize_packages}
library(tidyverse)
library(morris)
library(broom)
library(knitr)
library(broman)
```

```{r initialize_variables}
source('R/functions.R')
```

```{r import_data}
heritability <- read_tsv(paste0(der_dir, 'heritability.tsv'))

```
# Test heritability as mid-offspring on mid-parent

```{r test_treatment}
fit_no_treat <- lm(offspring ~ selected, data = heritability)
kable(tidy(fit_no_treat))
herit_model <- lm(offspring ~ selected * treat, data = heritability)
kable(tidy(herit_model))
kable(tidy(anova(fit_no_treat, herit_model)))
```

Here, I fit two models. The first is simply offspring flux on selected parent flux, ignoring treatment. There is no correlation `r print_lm(fit_no_treat, 2)`. Next, I added treatment and the interaction between treatment and parental flux. Here, there is a significant correlation between parent and offspring for both the Neutral treatment `r print_lm(herit_model, 2)` and the Positive treatment `r print_lm(herit_model, 4)`. Notably, the sign of the effect is reversed: negative for the Neutral treatment and positive for the Positive treatment.

```{r plot_herit}

  ratio <- calc_plot_ratios(heritability$selected, heritability$offspring)
p_herit <- 
  ggplot(heritability, aes(selected, offspring, color = treat)) +
    geom_point() + 
    stat_smooth(method = 'lm', se = FALSE, formula = 'y ~ x') +
    labs(x = expression(Parental ~ log[10] ~ CH[4] ~ "(-k)"), 
         y = expression(atop(Offspring, log[10] ~ CH[4] ~ "(-k)"))) +
    scale_color_manual(name = "Treatment", 
                       labels = c('Neutral', 'Positive'), 
                       values = c('gray40', 'darkorange2')) +
    coord_fixed(ratio)

p_herit

save(p_herit, file = 'Output/herit_plot.RData')

ggsave('Manuscript/fig2.jpg', p_herit, width = 4, height = 3) 
ggsave('Manuscript/fig2.svg', p_herit, width = 4, height = 3) 


```

```{r save_heritability}
save(herit_model, file = 'Output/herit_model.RData')
```

```{r}
heritability_each <- read_tsv(paste0(der_dir, 'heritability_each.tsv'))

fit_no_treat <- lm(offspring ~ selected, data = heritability_each)
kable(tidy(fit_no_treat))
herit_model <- lm(offspring ~ selected * treat, data = heritability_each)
kable(tidy(herit_model))
kable(tidy(anova(fit_no_treat, herit_model)))

ratio <- calc_plot_ratios(heritability_each$selected, heritability_each$offspring)
p_herit_each <- 
ggplot(heritability_each, aes(selected, offspring, color = treat)) +
    # theme_classic() +
    # geom_rangeframe(color = 'black') +
    geom_point() + 
    stat_smooth(method = 'lm', se = FALSE, formula = 'y ~ x') +
    labs(x = expression(atop(Mean ~ Parental, log[10] ~ CH[4] ~ "(-k)")), 
         y = expression(atop(Offspring, log[10] ~ CH[4] ~ "(-k)"))) +
    scale_color_manual(name = "Treatment", 
                       labels = c('Neutral', 'Positive'), 
                       values = c('gray40', 'darkorange2')) +
    coord_fixed(ratio)

save(p_herit_each, file = 'Output/herit_plot.RData')

ggsave('Manuscript/fig2_each.jpg', p_herit_each, width = 4, height = 3) 
ggsave('Manuscript/fig2_each.svg', p_herit_each, width = 4, height = 3) 
```


