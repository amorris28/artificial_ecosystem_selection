---
title: "Heritability"
author: "Andrew Morris"
date: "`r Sys.Date()`"
output: html_document
---

This script imports the heritability data. This dataset includes the mean flux
withn treatmentxgeneration for 1) all parents, 2) selected parents, and 3)
offspring. Then, it plots offspring on the selection parents with the two
treatments combined and then separately for the two treatments.



```{r initialize_packages}
library(tidyverse)
library(morris)
library(broom)
library(knitr)
library(broman)
```

```{r initialize_variables}
source('functions.R')
```

```{r import_data}
heritability <- read_tsv(paste0(der_dir, 'heritability.tsv'))

```
# Test heritability as mid-offspring on mid-parent

```{r test_treatment}
fit_no_treat <- lm(offspring ~ selected, data = heritability)
kable(tidy(fit_no_treat))
herit_model <- lm(offspring ~ selected * treat, data = heritability)
kable(tidy(herit_model))
kable(tidy(anova(fit_no_treat, herit_model)))
```

Here, I fit two models. The first is simply offspring flux on selected parent flux, ignoring treatment. There is no correlation `r print_model(fit_no_treat, 2)`. Next, I added treatment and the interaction between treatment and parental flux. Here, there is a significant correlation between parent and offspring for both the Neutral treatment `r print_model(herit_model, 2)` and the Positive treatment `r print_model(herit_model, 4)`. Notably, the sign of the effect is reversed: negative for the Neutral treatment and positive for the Positive treatment.

The negative heritability of methane oxidation rate in the Neutral selection treatment may result from selection on alternative characters in those populations. The strong, positive heritability in the Positive treatment ... . It seems strange that the 

```{r plot_herit}

plot_herit(heritability)

```

```{r save_heritability}
save(herit_model, file = '../Output/herit_model.Rdata')
```


######################################################################
# End of the way I should be doing it
################################################################


The Old way:

It then calculates S, the selection differential, as the mean difference between the selected parents and all parents. Because passage 2 was accidentaly selected for the lowest methane oxidation rate, I take the absolute value of this difference, i.e. |S|. Next, it imports the deviance data and calculates R, the respones to selection, as the slope of mean difference in flux (positive - neutral) over time. 
 
An alternative approach would be to calculate R directly instead of approximating it using the slope as in the equation offspring - parent. In this case, I would not be using the deviance, but instead the raw fluxes. I can do that with the heritability dataset.

# Function for the Breeder's equation

```{r eval=FALSE, include=FALSE}
breeders <- function(R, S) {
  R / S
}

#

selected <- 
  fluxes[paste0(fluxes$passage, fluxes$jar) %in% paste0(selected_jars$passage, selected_jars$jar), ] %>%
  select(treat, log_ch4, passage) %>% 
  group_by(treat, passage) %>% 
  summarize(selected = mean(log_ch4), .groups = 'drop')

parents <- 
  fluxes %>%
  select(treat, log_ch4, passage) %>% 
  group_by(treat, passage) %>% 
  summarize(parental = mean(log_ch4), .groups = 'drop')

offspring <- 
  fluxes %>% 
  select(passage, treat, log_ch4) %>% 
  filter(passage != 1) %>% 
  mutate(passage = passage - 1) %>% 
  group_by(treat, passage) %>% 
  summarize(offspring = mean(log_ch4), .groups = 'drop')

heritability <- 
  offspring %>% 
  left_join(selected, by = c('passage', 'treat')) %>% 
  left_join(parents, by = c('passage', 'treat'))
      
# Matt's approach: h2 for each generation
h2_per_gen  <- 
heritability %>% 
  mutate(R = offspring - parental) %>% 
  mutate(S = selected - parental) %>% 
  mutate(h2 = breeders(R, S))

write_tsv(h2_per_gen, 'Output/h2_per_gen.tsv')

ggplot(h2_per_gen, aes(x = passage, color = treat, y = h2)) +
  geom_point()

h2_per_gen %>% 
  select(treat, passage, h2)

h2_per_gen %>% 
  select(treat, passage, h2) %>% 
  group_by(treat) %>% 
  summarize(mean_h2 = mean(h2), sd_h2 = sd(h2), .groups = 'drop')

# Calculate R using regression of deviance over time.
# Calculate S using math.

dev_fit <- readRDS('../Output/dev_fit.rds')
R <- dev_fit$beta[2]

S <-
  heritability %>%
  filter(treat == "p") %>%
  mutate(S = abs(selected - parental)) %>%
  summarize(S = mean(S))  %>% 
  pull()

h2_reg_dev <- breeders(R, S)

lm_fit <- 
  fluxes %>% 
  filter(treat == 'p') %>% 
  select(treat, passage, ch4) %>% 
  lm(ch4 ~ passage, data = .) 

R_not_dev <- pull(tidy(lm_fit)[2, 2])
h2_reg_abs <- breeders(R_not_dev, S)

# Calculate R as regression of offspring on parents

ggplot(heritability, aes(x = parental, y = offspring)) +
  geom_point() + 
  stat_smooth(method = 'lm', se = FALSE)
summary(lm(offspring ~ parental, data = heritability, subset = treat == 'p'))
# Calculate h2 (heritability) using math, not regression
# For each generation and then calculate the mean/se
h2_calc_method <-
  heritability %>%
  filter(treat == "p") %>%
  mutate(S = abs(selected - parental)) %>%
  mutate(R = offspring - parental) %>%
  mutate(h2 = breeders(R, S)) %>%
  summarize(S = mean(S),
            R = mean(R),
            se = se(h2),
            h2 = mean(h2))

h2_calc_method_no_2 <-
  heritability %>%
  filter(treat == "p") %>%  
  filter(passage != 2) %>%
  mutate(S = abs(selected - parental)) %>%
  mutate(R = offspring - parental) %>%
  mutate(h2 = breeders(R, S)) %>%
  summarize(S = mean(S),
            R = mean(R),
            se = se(h2),
            h2 = mean(h2))

h2 <- 
  h2_calc_method %>% 
  mutate(method = "calc p")

h2_no2 <- 
  h2_calc_method_no_2 %>% 
  mutate(method = "calc p no 2")


h2 <- rbind(h2, h2_no2)

# Cumulative response to selection

parent <- heritability[[1, 3]]
offspr <- heritability[[8, 4]]
select <- heritability[[8, 5]]
R = offspr - parent
S = select - parent
h2 = breeders(R, S)

heritability[,'cum_res'] <- NA
heritability$cum_sel <- NA
herit_p <- filter(heritability, treat == 'p')
for (i in seq(nrow(herit_p))) {
  off <- sum(herit_p$offspring[1:i])
  par <- sum(herit_p$parental[1:i])
  sel <- sum(herit_p$selected[1:i])
  herit_p$cum_res[i] <- off - par
  herit_p$cum_sel[i] <- sel - par
}
herit_p$cum_h2 <- herit_p$cum_res / herit_p$cum_sel

ggplot(herit_p, aes(x = cum_sel, y = cum_res)) + 
  theme_classic() +
  labs(x = 'Cumulative selection differential',
       y = 'Cumulative response to selection') +
  geom_point() + 
  stat_smooth(method = 'lm', se = FALSE)
summary(lm(cum_res ~ cum_sel, data = herit_p))

# Regression of offspring on mid-parent

selected_jars <- read_csv('../Data/selected.csv')
fluxes <- read_tsv('../Output/fluxes.tsv')

# Pull out the selected parental jars
selected <- 
  fluxes[paste0(fluxes$passage, fluxes$jar) %in% paste0(selected_jars$passage, selected_jars$jar), ] %>%
  select(treat, ch4, passage) %>% 
  group_by(treat, passage) %>% 
  summarize(parental = mean(ch4), .groups = 'drop')

offspring <- 
  fluxes %>% 
  select(passage, treat, ch4) %>% 
  filter(passage != 1) %>% 
  mutate(passage = passage - 1) %>% 
  rename(offspring = ch4)

heritability <- 
  offspring %>% 
  left_join(selected, by = c('passage', 'treat'))

heritability

ggplot(heritability, aes(parental, offspring)) +
  theme_classic() +
  geom_point() + 
  stat_smooth(method = 'lm', se = FALSE)

summary(lm(offspring ~ parental, data = heritability))

ggplot(heritability, aes(parental, offspring, color = treat)) +
  theme_classic() +
  geom_point() + 
  stat_smooth(method = 'lm', se = FALSE)
summary(lm(offspring ~ parental * treat, data = heritability))
```


