---
title: "Artificial Ecosystem Selection: Methane Oxidation"
author: "Andrew Morris"
output:
  html_document:
      toc: true
      toc_float: 
        collapsed: false
editor_options: 
  chunk_output_type: inline
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,  fig.align="center")
library(tidyverse)
library(knitr)
library(kableExtra)
library(broom)
library(modelr)
library(lubridate)
library(morris)
library(magrittr)
library(metafor)
library(lme4)
```

# Standard Curves

Standard curves for each sc_date. (Some flux_dates have multiple standard curves if the instrument drifted from day to day as indicated by check standards.)

```{r sc_data, fig.height=4}

sc <- read.csv('../Data/standard_curve.csv')
sc_dates <- read.csv('../Data/sc_dates.csv')

# sc %>% 
#   filter(molecule == 'ch4') %>% 
# ggplot(mapping = aes(area, injection_ppm)) +
#   facet_wrap(~ sc_date + molecule, scales = "free") + 
#   geom_point() +
#   stat_smooth(formula = y ~ x, method = 'lm', se = FALSE)

sc_model <- function(df) {lm(injection_ppm ~ area, data = df)}
standard_curves <- 
  sc %>% 
  filter(molecule == 'ch4') %>% 
  group_by(flux_date, sc_date) %>% 
  nest() %>% 
  mutate(model = map(data, sc_model),
         glance = map(model, glance),
         tidy = map(model, tidy)) 
sc_r2 <- 
  standard_curves %>% 
  unnest(glance) %>% 
  select(flux_date, sc_date, r.squared)
sc_equation <- 
  standard_curves %>% 
  unnest(tidy) %>%
  select(flux_date, sc_date, term, estimate) %>% 
  spread(term, estimate) %>% 
  rename(intercept = `(Intercept)`, slope = area)
sc_ch4 <- left_join(sc_r2, sc_equation, by = c("flux_date", "sc_date"))

# sc_ch4 %>% 
#   kable() %>% 
#   kable_styling()

sc_ch4 <- 
sc_ch4 %>% 
  left_join(sc_dates, by = "sc_date") %>% 
  select(flux_date:sc_date, t, r.squared:slope)

```


# Fluxes

```{r time_data}
time_data <- data.table::fread('../Data/time_data.csv')

time_data[, c('t0', 't1', 't2', 't3', 't4', 't5')] <- 
  lapply(time_data[, c('t0', 't1', 't2', 't3', 't4', 't5')],
         ymd_hms)

as.days <- function(start, end) {as.numeric(interval(start, end))/60/60/24}

time_data[, c('t1', 't2', 't3', 't4', 't5')] <- 
  lapply(time_data[, c('t1', 't2', 't3', 't4', 't5')],
         function(x) as.days(time_data$t1, x))
time_data <- 
 time_data %>% 
  select(-t0) %>% 
  gather(t, days, t1:t5) %>% 
  mutate(flux_date = factor(flux_date))
```

```{r}
conc_data <- data.table::fread('../Data/conc_data.csv')

conc_data <- 
  conc_data %>% 
  filter(molecule == 'ch4') %>% 
  mutate(flux_date = factor(flux_date)) %>% 
  gather(t, area, t1:t5) %>% 
  left_join(sc_ch4, by = c('flux_date', 't')) %>% 
  mutate(ppm = area * slope + intercept) %>% 
  select(flux_date, jar, t, ppm) %>% 
  spread(t, ppm)

ln_ch0_chn <- function(t0, tn) {
  log(t0/tn)
}

conc_data[, c('t1', 't2', 't3', 't4', 't5')] <- 
  lapply(conc_data[, c('t1', 't2', 't3', 't4', 't5')],
         function(x) ln_ch0_chn(conc_data$t1, x))

flux_data <-
  conc_data %>% 
  gather(t, ppm, t1:t5) %>% 
  left_join(time_data, by = c('flux_date', 'jar', 't'))

flux_data <- 
  flux_data %>% 
  mutate(flux_date = factor(ymd(flux_date)), 
         jar = factor(jar),
         t = factor(t)) %>% 
  mutate(rep = factor(substr(jar, 2, 3)),
         treat = factor(substr(jar, 1, 1)))
```

Each column is jar by number (the jar numbers are arbitrary - there is no relationship between the communities of jar 01, passage 1 and jar 01, passage 2). Rows are each selection treatment (positive = p, neutral = n) within each passage (indicated by the date flux was measured). Lines are proportion of ppm CH4 consumed per day.

```{r flux_curves, warning = FALSE, fig.height=8}

flux_data %>% 
  ggplot(aes(days, ppm)) + 
  facet_grid(flux_date + treat ~ rep, scales = "free") +
  geom_point() + 
  stat_smooth(method = 'lm', formula = y ~ x)

```

```{r flux_model}
lin_model <- function(dt) {
  lm(ppm ~ days, data = dt)
}

nested <- 
  flux_data %>% 
  group_by(flux_date, jar, treat, rep) %>% 
  nest() %>% 
  mutate(model = map(data, lin_model))

fluxes <-
  nested %>% 
  mutate(tidy = map(model, tidy)) %>% 
  unnest(tidy) %>% 
  filter(term == 'days') %>% 
  group_by(flux_date) %>% 
  arrange(estimate, .by_group = TRUE) %>% 
  select(-data, -model, -term) %>% 
  ungroup() %>% 
  mutate(passage = as.numeric(flux_date)) %>% 
  mutate(estimate_rank = rank(estimate)) %>% 
  filter(passage != 6)

write_tsv(fluxes, '../Output/fluxes.tsv')

```

Histograms and boxplots of flux estimates for each jar within each treatment. The numbered points give an indication of which jars were the greatest methane consumers

```{r plot_estimates}
# ggplot(fluxes, aes(x = estimate, fill = treat)) +
#   facet_wrap(~ flux_date, scales = "free") +
#   geom_histogram(position = 'identity', alpha = 0.5, bins = 20)

ggplot(fluxes, aes(y = estimate, x = treat, color = treat)) +
  facet_wrap(~ flux_date, scales = "free") +
  geom_boxplot(outlier.shape = NA) +
  geom_label(aes(label = rep))
```

# Response to Selection

```{r eval=FALSE, include=FALSE}
deviance <-
  fluxes %>% 
  select(treat, passage, estimate) %>% 
  group_by(passage, treat) %>% 
  summarize(mean = mean(estimate), .groups = "drop") %>% 
  pivot_wider(names_from = treat, values_from = mean) %>% 
  mutate(deviance = p - n)

se <- function(x, na.rm = FALSE){
  sqrt(var(if (is.vector(x) || is.factor(x)) x else as.double(x), 
    na.rm = na.rm)) / sqrt(length(if (na.rm == TRUE) na.omit(x) else x))
}

sed <- function(p, n, na.rm = FALSE) {
  sqrt(se(p, na.rm = na.rm) ^ 2 + se(n, na.rm = na.rm)^ 2)
}

deviance$se <-
  fluxes %>% 
  select(treat, passage, estimate) %>% 
  mutate(x = 1:nrow(fluxes)) %>% 
  pivot_wider(names_from = treat, values_from = estimate) %>% 
  group_by(passage) %>% 
  summarize(sed = sed(p, n, na.rm = TRUE), .groups = "drop") %>% 
  pull(sed)


fit <- rma(deviance ~ passage, se^2, method="FE", data = deviance)

ggplot(deviance, aes(x = passage, y = deviance, ymin = deviance - se, ymax = deviance + se)) + 
  geom_pointrange(color = 'darkorange2') + 
  geom_abline(intercept = fit$beta[1], slope = fit$beta[2], color = 'blue')

rma_output <- data.frame(
Estimate = fit$beta,
se = fit$se,
z.value = fit$zval,
p.value = fit$pval,
upper.ci = fit$ci.lb,
lower.ci = fit$ci.ub
)
rma_output %>% 
  kable() %>% 
  kable_styling()

write.csv(deviance, 
```


# Heritability



```{r heritability, message=FALSE, warning=FALSE}
selected_jars <- read_csv('../Data/selected.csv')

parental <- 
  fluxes[paste0(fluxes$passage, fluxes$jar) %in% paste0(selected_jars$passage, selected_jars$jar), ] %>% 
  ungroup() %>% 
  select(treat, rep, estimate, passage)

# Mean parental (selected) flux for each passage
parental <-
  parental %>% 
  group_by(passage, treat) %>% 
  summarize(parental = mean(estimate), .groups = "drop")

offspring <- 
  fluxes %>% 
  ungroup() %>%
  select(treat, rep, estimate, passage)

# Mean offspring flux for each passage
offspring <-
  offspring %>% 
  group_by(passage, treat) %>%
  summarize(offspring = mean(estimate), .groups = "drop") %>%
  filter(passage != 1) %>% 
  mutate(passage = passage - 1)
```



```{r}

###################################################
# This is the nest place you stopped
# You need to calculate the slope of midoffspring
# on midparent for the Positive treatments to get R
# and then calculate the selection differential
# as above S. S doesn't make sense for the neutral
# treatment.
###################################################

# offspring <-
#   fluxes %>%
#   ungroup() %>%
#   select(estimate, passage, treat) %>%
#   mutate(offspring = rank(estimate))

heritability <- left_join(parental, offspring, by = c("passage", "treat"))
heritability$passage <- factor(heritability$passage)
heritability$treat <- factor(heritability$treat)
heritability <-
  filter(heritability, passage != 5)
# heritability$parental <- rank(heritability$parental)

write_tsv(heritability, '../Output/heritability.tsv')

ggplot(heritability, aes(x = parental, y = offspring)) +
  geom_point(aes(color = treat)) +
  stat_smooth(method = 'lm') + 
  labs(x = "Parental Mean Flux (-k)", y = "Offspring Flux (-k)") +
  scale_color_discrete(name = "Selection\nTreatment", labels = c('Neutral', 'Positive')) +
  theme_bw()

# ggsave('heritability.pdf', width = 4, height = 3)
# ggsave('heritability.png', width = 4, height = 3)

```
```{r}
# This chunk calculates the slope of mid-offspring on mid-parent for all generations and all treatments

fluxes
```


```{r breeders}

h2 <- function(R, S) {
  R / S
}

# R = Response to selection, difference in mean between offspring of selected parents and all of the parents

# S = Selection differental, difference in mean between selected parents and all of the parents

parental_all <-
  fluxes %>% 
  select(passage, treat, estimate) %>% 
  group_by(passage, treat) %>% 
  summarize(all = mean(estimate), .groups = "drop")


parental_selected <- parental

selection_diff <- 
  left_join(parental_selected, parental_all) %>% 
  rename(selected = parental) %>% 
  mutate(S = selected - all)

heritability_ns <- 
  parental_all %>% 
  left_join(parental_selected) %>% 
  left_join(offspring) %>% 
  filter(passage != 5)

heritability_only_p <- 
  heritability_ns %>% 
  filter(treat == 'p') 

R <- tidy(lm(offspring ~ all, data = heritability_only_p))[[2, 2]]
S <- tidy(lm(parental ~ all, data = heritability_only_p))[[2, 2]]
h2(R, S)

# Generational R, S, global h2, 0.82
heritability_only_p %>% 
  mutate(R = offspring - all,
         S = parental - all) %>% 
  summarize(R = mean(R),
            S = mean(S)) %>%
  mutate(h2 = h2(R, S))

# Generational R, S, h2, 0.73
heritability_only_p %>% 
  #filter(passage != 2) %>% 
  mutate(R = offspring - all,
         S = parental - all,
         h2 = h2(R, S)) %>% 
  summarize(se = se(h2),
            h2 = mean(h2))

# Global R, S, h2, 0.82
heritability_only_p %>% 
  summarize(offspring = mean(offspring),
         all = mean(all),
         parental = mean(parental)) %>% 
  mutate(R = offspring - all,
         S = parental - all,
         h2 = h2(R, S))
heritability_ns %>% 
  pivot_longer(all:offspring, names_to = "group", values_to = "mean") %>% 
ggplot(., aes(x = passage, y = mean, color = group)) +
  facet_wrap(~ treat) +
  geom_point()
```
