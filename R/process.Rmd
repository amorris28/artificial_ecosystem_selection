---
title: "Artificial Ecosystem Selection: Methane Oxidation"
author: "Andrew Morris"
output:
  html_document:
      toc: true
      toc_float: 
        collapsed: false
editor_options: 
  chunk_output_type: inline
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,  fig.align="center")
library(tidyverse)
library(knitr)
library(kableExtra)
library(broom)
library(modelr)
library(lubridate)
library(morris)
library(magrittr)
library(metafor)
```

### Standard Curve

```{r sc_data, fig.height=3}

sc <- read.csv('../Data/standard_curve.csv')
sc_dates <- read.csv('../Data/sc_dates.csv')

sc %>% 
  filter(molecule == 'ch4') %>% 
ggplot(mapping = aes(area, injection_ppm)) +
  facet_wrap(~ sc_date + molecule, scales = "free") + 
  geom_point() +
  stat_smooth(formula = y ~ x, method = 'lm', se = FALSE)

sc_model <- function(df) {lm(injection_ppm ~ area, data = df)}
standard_curves <- 
  sc %>% 
  filter(molecule == 'ch4') %>% 
  group_by(flux_date, sc_date) %>% 
  nest() %>% 
  mutate(model = map(data, sc_model),
         glance = map(model, glance),
         tidy = map(model, tidy)) 
sc_r2 <- 
  standard_curves %>% 
  unnest(glance) %>% 
  select(flux_date, sc_date, r.squared)
sc_equation <- 
  standard_curves %>% 
  unnest(tidy) %>%
  select(flux_date, sc_date, term, estimate) %>% 
  spread(term, estimate) %>% 
  rename(intercept = `(Intercept)`, slope = area)
sc_ch4 <- left_join(sc_r2, sc_equation, by = c("flux_date", "sc_date"))
sc_ch4 %>% 
  kable() %>% 
  kable_styling()

sc_ch4 <- 
sc_ch4 %>% 
  left_join(sc_dates) %>% 
  select(flux_date:sc_date, t, r.squared:slope)

```

### Flux Measurements

```{r time_data}

time_data <- data.table::fread('../Data/time_data.csv')

time_data[, c('t0', 't1', 't2', 't3', 't4', 't5')] <- 
  lapply(time_data[, c('t0', 't1', 't2', 't3', 't4', 't5')],
         ymd_hms)

as.days <- function(start, end) {as.numeric(interval(start, end))/60/60/24}

time_data[, c('t1', 't2', 't3', 't4', 't5')] <- 
  lapply(time_data[, c('t1', 't2', 't3', 't4', 't5')],
         function(x) as.days(time_data$t1, x))
time_data <- 
 time_data %>% 
  select(-t0) %>% 
  gather(t, days, t1:t5) %>% 
  mutate(flux_date = factor(flux_date))

```




```{r}

conc_data <- data.table::fread('../Data/conc_data.csv')


conc_data <- 
  conc_data %>% 
  filter(molecule == 'ch4') %>% 
  mutate(flux_date = factor(flux_date)) %>% 
  gather(t, area, t1:t5) %>% 
  left_join(sc_ch4, by = c('flux_date', 't')) %>% 
  mutate(ppm = area * slope + intercept) %>% 
  select(flux_date, jar, t, ppm) %>% 
  spread(t, ppm)

ln_ch0_chn <- function(t0, tn) {
  log(t0/tn)
}

conc_data[, c('t1', 't2', 't3', 't4', 't5')] <- 
  lapply(conc_data[, c('t1', 't2', 't3', 't4', 't5')],
         function(x) ln_ch0_chn(conc_data$t1, x))
flux_data <-
conc_data %>% 
  gather(t, ppm, t1:t5) %>% 
  left_join(time_data, by = c('flux_date', 'jar', 't'))


flux_data <- 
  flux_data %>% 
  mutate(flux_date = factor(ymd(flux_date)), 
         jar = factor(jar),
         t = factor(t)) %>% 
  mutate(rep = factor(substr(jar, 2, 3)),
         treat = factor(substr(jar, 1, 1)))

```

# Flux

```{r flux_curves, warning = FALSE, fig.height=8}

flux_data %>% 
  ggplot(aes(days, ppm)) + 
  facet_grid(flux_date + treat ~ rep, scales = "free") +
  geom_point() + 
  stat_smooth(method = 'lm')

```


# Fluxes

```{r flux_model}
lin_model <- function(dt) {
  lm(ppm ~ days, data = dt)
}

nested <- 
flux_data %>% 
  group_by(flux_date, jar, treat, rep) %>% 
  nest() %>% 
  mutate(model = map(data, lin_model))

fluxes <-
  nested %>% 
  mutate(tidy = map(model, tidy)) %>% 
  unnest(tidy) %>% 
  filter(term == 'days') %>% 
  group_by(flux_date) %>% 
  arrange(estimate, .by_group = TRUE) %>% 
  select(-data, -model, -term) %>% 
  ungroup() %>% 
  mutate(passage = as.numeric(flux_date)) %>% 
  mutate(estimate_rank = rank(estimate))

write_tsv(fluxes, '../Output/fluxes.tsv')

```

```{r plot_estimates}
ggplot(fluxes, aes(x = estimate, fill = treat)) +
  facet_wrap(~ flux_date, scales = "free") +
  geom_histogram(position = 'identity', alpha = 0.5, bins = 20)

ggplot(fluxes, aes(y = estimate, x = treat, color = treat)) +
  facet_wrap(~ flux_date, scales = "free") +
  geom_boxplot(outlier.shape = NA) +
  geom_label(aes(label = rep))
```




```{r test_response}

fluxes$passage <- as.numeric(fluxes$flux_date)

fit <- lm(estimate ~ treat * passage, data = fluxes)
plot(fit$residuals ~ fluxes$estimate)
selection_table <- tidy(anova(fit))


selection_table[1, 1] <- "Treatment"
selection_table[2, 1] <- "Passage"
selection_table[3, 1] <- "Treatment:Passage"
selection_table[4, 1] <- "Residuals"

selection_table %>% 
  kable(col.names = c('Term', 'Df', 'Sum Sq', 'Mean Sq', 'F Value', 'p-value')) %>% 
  kable_styling()

```


```{r selection}

fluxes %>% 
  ggplot(mapping = aes(x = passage, y = estimate, color = treat)) + 
  geom_boxplot(aes(x = passage, y = estimate, color = treat, group = interaction(treat, passage))) +
  geom_jitter(width = 0.2) +
  #geom_smooth(method = 'lm') +
  labs(x = "Passage Number", y = "Methane Oxidation Rate (-k)") +
  scale_color_discrete(name = "Selection Treatment", labels = c('Neutral', 'Positive')) +
  theme_bw()

#ggsave('selection.pdf', width = 6, height = 4)
```

```{r selection_log_plot}

log_fluxes <- fluxes
#log_fluxes$estimate[log_fluxes$estimate < 0] <- 0.01
log_fluxes$estimate <- log10(log_fluxes$estimate + abs(min(log_fluxes$estimate)) + 0.01)

fit <- lm(estimate ~ treat * passage, data = log_fluxes)
summary(fit)
plot(fit$residuals ~ log_fluxes$estimate)

selection_table <- tidy(anova(fit))

#selection_table[1, 1] <- "Neutral0"
#selection_table[2, 1] <- "Positive0"
#selection_table[3, 1] <- "Passage#"
#selection_table[4, 1] <- "Positive:Passage#"


selection_table[1, 1] <- "Treatment"
selection_table[2, 1] <- "Passage"
selection_table[3, 1] <- "Treatment:Passage"
selection_table[4, 1] <- "Residuals"

selection_table %>% 
  kable(col.names = c('Term', 'Df', 'Sum Sq', 'Mean Sq', 'F Value', 'p-value')) %>% 
  kable_styling()


log_fluxes %>% 
  ggplot(mapping = aes(x = passage, y = estimate, color = treat)) +
  geom_jitter(width = 0.2) +
  geom_smooth(method = 'lm') +
  labs(x = "Passage Number", y = "log10(Methane Oxidation Rate (-k))") +
  scale_color_discrete(name = "Selection Treatment", labels = c('Neutral', 'Positive')) +
  theme_bw() +
  scale_y_log10()

#ggsave('selection.pdf', width = 6, height = 4)

log_fluxes %>% 
  ggplot(mapping = aes(x = passage, y = estimate, color = treat)) +
  geom_jitter(width = 0.2) +
  #geom_smooth(method = 'lm') +
  labs(x = "Passage Number", y = "Methane Oxidation Rate (-k)") +
  scale_color_discrete(name = "Selection Treatment", labels = c('Neutral', 'Positive')) +
  theme_bw() + 
  geom_boxplot(aes(x = passage, y = estimate, color = treat, group = interaction(treat, passage)))
```

```{r test_response_rank}

fluxes$estimate_rank <- rank(fluxes$estimate)
rank_fit <- lm(estimate_rank ~ treat * passage, data = fluxes)

rank_fit
summary(rank_fit)
anova(rank_fit)

plot(fit$residuals ~ fluxes$estimate_rank)

```

```{r}
selection_table <- tidy(anova(rank_fit))
selection_table[1, 1] <- "Treatment"
selection_table[2, 1] <- "Passage"
selection_table[3, 1] <- "Treatment:Passage"
selection_table[4, 1] <- "Residuals"
selection_table %>% 
  kable(col.names = c('Term', 'Df', 'Sum Sq', 'Mean Sq', 'F Value', 'p-value')) %>% 
  kable_styling()

selection_table <- tidy(car::Anova(rank_fit, type = "II"))
selection_table[1, 1] <- "Treatment"
selection_table[2, 1] <- "Passage"
selection_table[3, 1] <- "Treatment:Passage"
selection_table[4, 1] <- "Residuals"
selection_table %>% 
  kable(col.names = c('Term', 'Sum Sq', 'Df', 'F Value', 'p-value')) %>% 
  kable_styling()

selection_table <- tidy(car::Anova(rank_fit, type = "III"))
selection_table[1, 1] <- "Intercept"
selection_table[2, 1] <- "Treatment"
selection_table[3, 1] <- "Passage"
selection_table[4, 1] <- "Treatment:Passage"
selection_table[5, 1] <- "Residuals"
selection_table %>% 
  kable(col.names = c('Term', 'Sum Sq', 'Df', 'F Value', 'p-value')) %>% 
  kable_styling()

selection_table <- tidy(summary(rank_fit))

selection_table[1, 1] <- "Neutral"
selection_table[2, 1] <- "Positive"
selection_table[3, 1] <- "Passage"
selection_table[4, 1] <- "Positive:Passage"

selection_table %>% 
  kable(col.names = c('Term', 'Estimate', 'Std Error', 't-statistic', 'p-value')) %>% 
  kable_styling()

```



```{r selection_rank}

fluxes %>% 
  ggplot(mapping = aes(x = passage, y = estimate_rank, color = treat)) +
  geom_jitter(width = 0.2) +
  geom_smooth(method = 'lm') +
  labs(x = "Passage Number", y = "Rank Methane Oxidation Rate (-k)") +
  scale_color_discrete(name = "Selection Treatment", labels = c('Neutral', 'Positive')) +
  theme_bw()

ggsave('selection.pdf', width = 6, height = 4)
ggsave('selection.png', width = 6, height = 4)
```


```{r}

gm_mean = function(x, na.rm=TRUE){
  exp(sum(log(x[x > 0]), na.rm=na.rm) / length(x))
}

ggplot(fluxes, aes(x = estimate)) + 
  facet_wrap(~ passage + treat) +
  geom_dotplot(method = 'histodot') +
  geom_vline(aes(xintercept = mean(estimate)), color = 'blue') +
  geom_vline(aes(xintercept = median(estimate)), color = 'red') +
    geom_vline(aes(xintercept = gm_mean(estimate)), color = 'green')


```


# Deviance from mean

```{r}
deviance_se <- 
  fluxes %>% 
  select(treat, passage, estimate) %>% 
  group_by(passage, treat) %>% 
  summarize(se = se(estimate)) %>% 
  pivot_wider(names_from = treat, values_from = se) %>% 
  mutate(deviance_se = p + n) %>% 
  pull(deviance_se)
  

deviance <-
fluxes %>% 
  select(treat, passage, estimate) %>% 
  group_by(passage, treat) %>% 
  summarize(mean = mean(estimate)) %>% 
  pivot_wider(names_from = treat, values_from = mean) %>% 
  mutate(deviance = p - n)

deviance$se <- deviance_se



fit <- lm(deviance ~ passage, data = deviance)
summary(fit)

fit <- rma(deviance~passage,se^2,method="FE",data = deviance)
fit

summary(fit)
plot(fit)

ggplot(deviance, aes(x = passage, y = deviance, ymin = deviance - se, ymax = deviance + se)) + 
  geom_pointrange(color = 'darkorange2') + 
  geom_abline(intercept = fit$beta[1], slope = fit$beta[2], color = 'blue')

```


# Heritability

```{r heritability, message=FALSE, warning=FALSE}
selected_jars <- read_csv('../Data/selected.csv')

parental <- 
  fluxes[paste0(fluxes$passage, fluxes$jar) %in% paste0(selected_jars$passage, selected_jars$jar), ] %>% 
  ungroup() %>% 
  select(treat, rep, estimate, passage)

parental <-
  parental %>% 
  group_by(passage, treat) %>% 
  summarize(parental = mean(estimate)) %>% 
  ungroup() %>% 
  filter(passage != 5)

offspring <- 
  fluxes %>% 
  ungroup() %>%
  select(treat, rep, estimate, passage)

ggplot(offspring, aes(x = estimate, fill = factor(passage))) +
  geom_histogram(position = "identity", alpha = 0.5)

offspring <-
  offspring %>% 
  group_by(passage, treat) %>%
  summarize(offspring = mean(estimate)) %>%
  ungroup() %>%
  # mutate(offspring = estimate) %>%
  filter(passage != 1) %>% 
  mutate(passage = passage - 1)


# offspring <-
#   fluxes %>%
#   ungroup() %>%
#   select(estimate, passage, treat) %>%
#   mutate(offspring = rank(estimate))

heritability <- left_join(parental, offspring, by = c("passage", "treat"))
heritability$passage <- factor(heritability$passage)
heritability$treat <- factor(heritability$treat)
# heritability$parental <- rank(heritability$parental)

write_tsv(heritability, '../Output/heritability.tsv')

ggplot(heritability, aes(x = parental, y = offspring)) +
  geom_point(aes(color = treat)) +
  stat_smooth(method = 'lm') + 
  labs(x = "Parental Median Flux (-k)", y = "Offspring Flux (-k)") +
  scale_color_discrete(name = "Selection\nTreatment", labels = c('Neutral', 'Positive')) +
  theme_bw()

ggsave('heritability.pdf', width = 4, height = 3)
ggsave('heritability.png', width = 4, height = 3)
heritability$parental_sq <- heritability$parental^2
fit <- lm(sqrt(offspring) ~ parental, data = heritability)

summary(fit)
tidy(fit) %>% 
  kable() %>% 
  kable_styling()
glance(fit) %>% 
  kable() %>% 
  kable_styling()
ggplot(mapping = aes(fit$residuals, fit$fitted.values)) +
  geom_point()
ggplot(mapping = aes(fit$residuals, heritability$parental)) +
  geom_point()


ggplot(heritability, aes(x = parental, y = offspring)) +
  geom_point()


ggplot(heritability, aes(x = offspring)) +
  geom_histogram(position = 'identity', alpha = 0.5)

ggplot(heritability, aes(x = parental)) +
  geom_histogram(position = 'identity', alpha = 0.5)

```

